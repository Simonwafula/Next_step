<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Beta Program Dashboard - NextStep Admin</title>
    <link rel="stylesheet" href="styles/main.css">
    <style>
        .admin-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 40px 20px;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }
        .stat-card {
            background: white;
            padding: 24px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .stat-value {
            font-size: 36px;
            font-weight: 700;
            color: #2d3748;
            margin: 8px 0;
        }
        .stat-label {
            font-size: 14px;
            color: #718096;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .stat-change {
            font-size: 14px;
            margin-top: 8px;
        }
        .stat-change.positive { color: #38a169; }
        .stat-change.negative { color: #e53e3e; }

        .chart-section {
            background: white;
            padding: 24px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 24px;
        }
        .section-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 16px;
            color: #2d3748;
        }

        .funnel-container {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .funnel-stage {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 12px;
            background: #f7fafc;
            border-radius: 4px;
        }
        .funnel-bar {
            flex: 1;
            height: 32px;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            border-radius: 4px;
            display: flex;
            align-items: center;
            padding: 0 12px;
            color: white;
            font-weight: 600;
            font-size: 14px;
        }
        .funnel-label {
            min-width: 150px;
            font-weight: 500;
        }
        .funnel-count {
            min-width: 80px;
            text-align: right;
            font-weight: 600;
        }

        .user-table {
            width: 100%;
            border-collapse: collapse;
        }
        .user-table th {
            background: #f7fafc;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            font-size: 14px;
            color: #4a5568;
        }
        .user-table td {
            padding: 12px;
            border-top: 1px solid #e2e8f0;
            font-size: 14px;
        }
        .user-table tr:hover {
            background: #f7fafc;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        .status-badge.pending { background: #fef3c7; color: #92400e; }
        .status-badge.active { background: #d1fae5; color: #065f46; }
        .status-badge.paid { background: #dbeafe; color: #1e40af; }
        .status-badge.churned { background: #fee2e2; color: #991b1b; }

        .roi-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 32px;
            border-radius: 12px;
            margin-bottom: 24px;
        }
        .roi-card h2 {
            margin: 0 0 16px;
            font-size: 24px;
        }
        .roi-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 24px;
            margin-top: 24px;
        }
        .roi-metric {
            background: rgba(255,255,255,0.1);
            padding: 16px;
            border-radius: 8px;
        }
        .roi-metric-value {
            font-size: 32px;
            font-weight: 700;
        }
        .roi-metric-label {
            font-size: 14px;
            opacity: 0.9;
            margin-top: 4px;
        }

        .refresh-btn {
            padding: 8px 16px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
        }
        .refresh-btn:hover {
            background: #5568d3;
        }

        /* Admin Controls */
        .admin-controls {
            background: white;
            padding: 24px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 24px;
        }
        .control-row {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin-bottom: 16px;
        }
        .control-row input, .control-row select {
            padding: 8px 12px;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
            font-size: 14px;
        }
        .control-row input {
            flex: 1;
            min-width: 200px;
        }
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }
        .btn-primary {
            background: #667eea;
            color: white;
        }
        .btn-primary:hover {
            background: #5568d3;
        }
        .btn-secondary {
            background: #48bb78;
            color: white;
        }
        .btn-secondary:hover {
            background: #38a169;
        }
        .btn-danger {
            background: #f56565;
            color: white;
        }
        .btn-danger:hover {
            background: #e53e3e;
        }
        .btn-outline {
            background: white;
            color: #667eea;
            border: 2px solid #667eea;
        }
        .btn-outline:hover {
            background: #667eea;
            color: white;
        }
        .btn-sm {
            padding: 4px 8px;
            font-size: 12px;
        }
        .bulk-actions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 12px;
            margin-top: 16px;
        }
    </style>
</head>
<body data-api-base="/api">
    <header class="site-header">
        <div class="container header-inner">
            <div class="brand">
                <span class="brand-mark">N</span>
                <div>
                    <p class="brand-name">NextStep Careers</p>
                    <p class="brand-tag">Beta Program Dashboard</p>
                </div>
            </div>
            <nav class="nav-links">
                <button class="refresh-btn" onclick="loadDashboard()">üîÑ Refresh Data</button>
            </nav>
        </div>
    </header>

    <main class="admin-container">

        <!-- ROI Summary Card -->
        <div class="roi-card">
            <h2>üí∞ B2C Conversion Metrics</h2>
            <p>Key metrics for freemium business model viability (Target: 20% conversion rate).</p>
            <div class="roi-metrics">
                <div class="roi-metric">
                    <div class="roi-metric-value" id="roiConversionRate">--%</div>
                    <div class="roi-metric-label">Conversion Rate (Free ‚Üí Paid)</div>
                </div>
                <div class="roi-metric">
                    <div class="roi-metric-value" id="roiPaidUsers">--</div>
                    <div class="roi-metric-label">Paid Subscribers</div>
                </div>
                <div class="roi-metric">
                    <div class="roi-metric-value" id="roiMRR">KES --</div>
                    <div class="roi-metric-label">Monthly Recurring Revenue</div>
                </div>
                <div class="roi-metric">
                    <div class="roi-metric-value" id="roiEngagement">--%</div>
                    <div class="roi-metric-label">Avg Engagement Score</div>
                </div>
            </div>
        </div>

        <!-- Admin Controls -->
        <div class="admin-controls">
            <h3 class="section-title">üõ†Ô∏è Admin Actions</h3>

            <!-- Search and Filter -->
            <div class="control-row">
                <input type="text" id="searchInput" placeholder="üîç Search by name, email, or university..." onkeyup="filterUsers()">
                <select id="statusFilter" onchange="filterUsers()">
                    <option value="">All Statuses</option>
                    <option value="pending">Pending (Trial)</option>
                    <option value="active">Active (Free)</option>
                    <option value="paid">Paid (Converted)</option>
                    <option value="churned">Churned</option>
                </select>
                <select id="universityFilter" onchange="filterUsers()">
                    <option value="">All Universities</option>
                </select>
                <button class="btn btn-outline" onclick="clearFilters()">Clear Filters</button>
            </div>

            <!-- Bulk Actions -->
            <div class="bulk-actions-grid">
                <button class="btn btn-primary" onclick="exportToCSV()">üì• Export All to CSV</button>
                <button class="btn btn-secondary" onclick="sendBulkWhatsApp('pending')">üì± WhatsApp All Pending</button>
                <button class="btn btn-secondary" onclick="sendBulkWhatsApp('active')">üì± WhatsApp All Active</button>
                <button class="btn btn-outline" onclick="showEngagementReport()">üìä Engagement Report</button>
            </div>
        </div>

        <!-- Key Stats Grid -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">Total Signups</div>
                <div class="stat-value" id="totalSignups">0</div>
                <div class="stat-change" id="signupChange">-- of 50 slots filled</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Active Users</div>
                <div class="stat-value" id="activeUsers">0</div>
                <div class="stat-change" id="activationRate">--% activation rate</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Profile Completion</div>
                <div class="stat-value" id="profilesComplete">0</div>
                <div class="stat-change" id="profileRate">--% of users</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Jobs Viewed</div>
                <div class="stat-value" id="jobsViewed">0</div>
                <div class="stat-change" id="avgJobsViewed">-- avg per user</div>
            </div>
        </div>

        <!-- User Journey Funnel -->
        <div class="chart-section">
            <h3 class="section-title">üìç User Journey Funnel</h3>
            <div class="funnel-container" id="funnelContainer">
                <div class="funnel-stage">
                    <div class="funnel-label">1. Signed Up</div>
                    <div class="funnel-bar" style="width: 100%;" id="funnelSignup">
                        <span>0 users (100%)</span>
                    </div>
                    <div class="funnel-count">0</div>
                </div>
                <div class="funnel-stage">
                    <div class="funnel-label">2. Activated Account</div>
                    <div class="funnel-bar" style="width: 80%;" id="funnelActivate">
                        <span>0 users (0%)</span>
                    </div>
                    <div class="funnel-count">0</div>
                </div>
                <div class="funnel-stage">
                    <div class="funnel-label">3. Completed Profile</div>
                    <div class="funnel-bar" style="width: 60%;" id="funnelProfile">
                        <span>0 users (0%)</span>
                    </div>
                    <div class="funnel-count">0</div>
                </div>
                <div class="funnel-stage">
                    <div class="funnel-label">4. First Search</div>
                    <div class="funnel-bar" style="width: 50%;" id="funnelSearch">
                        <span>0 users (0%)</span>
                    </div>
                    <div class="funnel-count">0</div>
                </div>
                <div class="funnel-stage">
                    <div class="funnel-label">5. First Application</div>
                    <div class="funnel-bar" style="width: 30%;" id="funnelApplication">
                        <span>0 users (0%)</span>
                    </div>
                    <div class="funnel-count">0</div>
                </div>
            </div>
        </div>

        <!-- University Breakdown -->
        <div class="chart-section">
            <h3 class="section-title">üè´ Signups by University</h3>
            <div id="universityBreakdown"></div>
        </div>

        <!-- Recent Users Table -->
        <div class="chart-section">
            <h3 class="section-title">üë• Recent Beta Signups</h3>
            <table class="user-table">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>University</th>
                        <th>Year</th>
                        <th>Field of Study</th>
                        <th>Status</th>
                        <th>Engagement</th>
                        <th>Signed Up</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="recentUsersTable">
                    <tr><td colspan="8" style="text-align: center; padding: 24px;">Loading...</td></tr>
                </tbody>
            </table>
        </div>

    </main>

    <script>
        const API_BASE = document.body.getAttribute('data-api-base') || '/api';

        let allUsers = []; // Store all users for filtering
        let filteredUsers = []; // Currently filtered users

        async function loadDashboard() {
            try {
                // Load stats
                const statsResponse = await fetch(`${API_BASE}/beta/stats`);
                const stats = await statsResponse.json();

                // Update key metrics
                document.getElementById('totalSignups').textContent = stats.total_signups;
                document.getElementById('signupChange').textContent = `${stats.spots_remaining} of 50 slots remaining`;

                document.getElementById('activeUsers').textContent = stats.active_users;
                document.getElementById('activationRate').textContent = `${stats.activation_rate}% activation rate`;

                // Load detailed metrics
                const detailsResponse = await fetch(`${API_BASE}/beta/metrics`);
                const details = await detailsResponse.json();

                // Profile completion
                document.getElementById('profilesComplete').textContent = details.profiles_completed || 0;
                const profileRate = stats.total_signups > 0 ? Math.round((details.profiles_completed / stats.total_signups) * 100) : 0;
                document.getElementById('profileRate').textContent = `${profileRate}% of users`;

                // Jobs viewed
                const totalJobsViewed = details.total_jobs_viewed || 0;
                const avgJobsViewed = stats.active_users > 0 ? Math.round(totalJobsViewed / stats.active_users) : 0;
                document.getElementById('jobsViewed').textContent = totalJobsViewed;
                document.getElementById('avgJobsViewed').textContent = `${avgJobsViewed} avg per active user`;

                // B2C Conversion Metrics
                const paidUsers = (allUsers || []).filter(u => u.status === 'paid').length;
                const conversionRate = stats.total_signups > 0 ? Math.round((paidUsers / stats.total_signups) * 100) : 0;
                const mrr = paidUsers * 250; // Avg KES 250/month

                // Calculate average engagement score
                const avgEngagement = allUsers.length > 0
                    ? Math.round(allUsers.reduce((sum, u) => {
                        let score = 0;
                        if (u.profile_completed) score += 25;
                        if (u.jobs_viewed > 0) score += 20;
                        if (u.jobs_saved > 0) score += 25;
                        if (u.jobs_applied > 0) score += 30;
                        return sum + score;
                    }, 0) / allUsers.length)
                    : 0;

                document.getElementById('roiConversionRate').textContent = `${conversionRate}%`;
                document.getElementById('roiPaidUsers').textContent = paidUsers;
                document.getElementById('roiMRR').textContent = `KES ${mrr.toLocaleString()}`;
                document.getElementById('roiEngagement').textContent = `${avgEngagement}%`;

                // User Journey Funnel
                const funnel = details.funnel || {};
                updateFunnel(funnel, stats.total_signups);

                // University Breakdown
                renderUniversityBreakdown(stats.by_university);

                // Load recent users
                const usersResponse = await fetch(`${API_BASE}/beta/users?limit=50`);
                const users = await usersResponse.json();
                allUsers = users.users || [];
                filteredUsers = allUsers;

                // Populate university filter
                populateUniversityFilter(allUsers);

                renderUsersTable(allUsers);

            } catch (error) {
                console.error('Dashboard load error:', error);
            }
        }

        function updateFunnel(funnel, total) {
            const signups = total;
            const activated = funnel.activated || 0;
            const profileComplete = funnel.profile_complete || 0;
            const firstSearch = funnel.first_search || 0;
            const firstApplication = funnel.first_application || 0;

            // Calculate percentages
            const activatedPct = signups > 0 ? Math.round((activated / signups) * 100) : 0;
            const profilePct = signups > 0 ? Math.round((profileComplete / signups) * 100) : 0;
            const searchPct = signups > 0 ? Math.round((firstSearch / signups) * 100) : 0;
            const appPct = signups > 0 ? Math.round((firstApplication / signups) * 100) : 0;

            // Update funnel bars
            document.getElementById('funnelSignup').innerHTML = `<span>${signups} users (100%)</span>`;
            document.getElementById('funnelSignup').style.width = '100%';

            document.getElementById('funnelActivate').innerHTML = `<span>${activated} users (${activatedPct}%)</span>`;
            document.getElementById('funnelActivate').style.width = `${activatedPct}%`;

            document.getElementById('funnelProfile').innerHTML = `<span>${profileComplete} users (${profilePct}%)</span>`;
            document.getElementById('funnelProfile').style.width = `${profilePct}%`;

            document.getElementById('funnelSearch').innerHTML = `<span>${firstSearch} users (${searchPct}%)</span>`;
            document.getElementById('funnelSearch').style.width = `${searchPct}%`;

            document.getElementById('funnelApplication').innerHTML = `<span>${firstApplication} users (${appPct}%)</span>`;
            document.getElementById('funnelApplication').style.width = `${appPct}%`;
        }

        function renderUniversityBreakdown(byUniversity) {
            const container = document.getElementById('universityBreakdown');
            if (!byUniversity || Object.keys(byUniversity).length === 0) {
                container.innerHTML = '<p style="color: #718096;">No data yet</p>';
                return;
            }

            const sorted = Object.entries(byUniversity).sort((a, b) => b[1] - a[1]);
            const html = sorted.map(([university, count]) => `
                <div style="margin-bottom: 12px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                        <span style="font-weight: 500;">${university}</span>
                        <span style="font-weight: 600;">${count} students</span>
                    </div>
                    <div style="height: 8px; background: #e2e8f0; border-radius: 4px;">
                        <div style="height: 100%; background: linear-gradient(90deg, #667eea 0%, #764ba2 100%); border-radius: 4px; width: ${(count / sorted[0][1]) * 100}%;"></div>
                    </div>
                </div>
            `).join('');
            container.innerHTML = html;
        }

        function calculateEngagementScore(user) {
            let score = 0;
            if (user.profile_completed) score += 25;
            if (user.jobs_viewed > 0) score += 20;
            if (user.jobs_saved > 0) score += 25;
            if (user.jobs_applied > 0) score += 30;
            return score;
        }

        function getEngagementBadge(score) {
            if (score >= 75) return '<span style="color: #38a169; font-weight: 600;">üî• High</span>';
            if (score >= 50) return '<span style="color: #ed8936; font-weight: 600;">‚ö° Medium</span>';
            if (score >= 25) return '<span style="color: #f6ad55; font-weight: 600;">üí§ Low</span>';
            return '<span style="color: #a0aec0; font-weight: 600;">‚ùå None</span>';
        }

        function renderUsersTable(users) {
            const tbody = document.getElementById('recentUsersTable');
            if (users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 24px;">No users found</td></tr>';
                return;
            }

            const html = users.map(user => {
                const engagementScore = calculateEngagementScore(user);
                return `
                <tr data-email="${user.email}" data-university="${user.university}" data-status="${user.status}">
                    <td>
                        <div style="font-weight: 500;">${user.full_name}</div>
                        <div style="font-size: 12px; color: #718096;">${user.email}</div>
                    </td>
                    <td>${user.university}</td>
                    <td>Year ${user.year_of_study}</td>
                    <td>${user.field_of_study}</td>
                    <td><span class="status-badge ${user.status}">${user.status}</span></td>
                    <td>
                        <div style="font-weight: 600;">${engagementScore}%</div>
                        <div style="font-size: 11px;">${getEngagementBadge(engagementScore)}</div>
                    </td>
                    <td>
                        <div>${new Date(user.signed_up_at).toLocaleDateString()}</div>
                        <div style="font-size: 11px; color: #718096;">${user.last_active_at ? new Date(user.last_active_at).toLocaleDateString() : 'Never'}</div>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="sendWhatsAppToUser('${user.phone}', '${user.full_name}')">üì±</button>
                        <button class="btn btn-sm btn-outline" onclick="viewUserDetails(${user.id})">üëÅÔ∏è</button>
                    </td>
                </tr>
            `}).join('');
            tbody.innerHTML = html;
        }

        // Filter functions
        function populateUniversityFilter(users) {
            const universities = [...new Set(users.map(u => u.university))].sort();
            const select = document.getElementById('universityFilter');
            universities.forEach(uni => {
                const option = document.createElement('option');
                option.value = uni;
                option.textContent = uni;
                select.appendChild(option);
            });
        }

        function filterUsers() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value;
            const universityFilter = document.getElementById('universityFilter').value;

            filteredUsers = allUsers.filter(user => {
                const matchesSearch = !searchTerm ||
                    user.full_name.toLowerCase().includes(searchTerm) ||
                    user.email.toLowerCase().includes(searchTerm) ||
                    user.university.toLowerCase().includes(searchTerm);

                const matchesStatus = !statusFilter || user.status === statusFilter;
                const matchesUniversity = !universityFilter || user.university === universityFilter;

                return matchesSearch && matchesStatus && matchesUniversity;
            });

            renderUsersTable(filteredUsers);
        }

        function clearFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('statusFilter').value = '';
            document.getElementById('universityFilter').value = '';
            filteredUsers = allUsers;
            renderUsersTable(allUsers);
        }

        // Export function
        function exportToCSV() {
            if (filteredUsers.length === 0) {
                alert('No users to export');
                return;
            }

            const headers = ['Name', 'Email', 'Phone', 'University', 'Year', 'Field', 'Status', 'Engagement %', 'Jobs Viewed', 'Jobs Saved', 'Jobs Applied', 'Signed Up', 'Last Active'];
            const rows = filteredUsers.map(user => {
                const engagement = calculateEngagementScore(user);
                return [
                    user.full_name,
                    user.email,
                    user.phone,
                    user.university,
                    user.year_of_study,
                    user.field_of_study,
                    user.status,
                    engagement,
                    user.jobs_viewed,
                    user.jobs_saved,
                    user.jobs_applied,
                    new Date(user.signed_up_at).toLocaleDateString(),
                    user.last_active_at ? new Date(user.last_active_at).toLocaleDateString() : 'Never'
                ];
            });

            const csvContent = [
                headers.join(','),
                ...rows.map(row => row.map(cell => `"${cell}"`).join(','))
            ].join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `beta-users-${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        // Bulk WhatsApp function
        function sendBulkWhatsApp(status) {
            const users = allUsers.filter(u => u.status === status);
            if (users.length === 0) {
                alert(`No ${status} users found`);
                return;
            }

            const count = users.length;
            const phones = users.map(u => u.phone).join(', ');

            if (confirm(`Send WhatsApp message to ${count} ${status} users?\n\nPhones: ${phones.substring(0, 100)}${phones.length > 100 ? '...' : ''}`)) {
                alert(`WhatsApp integration pending. Would send to ${count} users:\n${phones}`);
                // TODO: Implement actual WhatsApp bulk send via backend endpoint
            }
        }

        // Individual user actions
        function sendWhatsAppToUser(phone, name) {
            if (confirm(`Send WhatsApp message to ${name} (${phone})?`)) {
                alert(`WhatsApp integration pending. Would send to ${phone}`);
                // TODO: Implement actual WhatsApp send
            }
        }

        function viewUserDetails(userId) {
            const user = allUsers.find(u => u.id === userId);
            if (!user) return;

            const engagement = calculateEngagementScore(user);
            const details = `
üìä USER DETAILS

Name: ${user.full_name}
Email: ${user.email}
Phone: ${user.phone}
University: ${user.university}
Year: ${user.year_of_study}
Field: ${user.field_of_study}
Status: ${user.status}

ENGAGEMENT METRICS
Overall Score: ${engagement}%
Profile Completed: ${user.profile_completed ? 'Yes' : 'No'}
Jobs Viewed: ${user.jobs_viewed}
Jobs Saved: ${user.jobs_saved}
Jobs Applied: ${user.jobs_applied}
Searches: ${user.searches_performed}

TIMELINE
Signed Up: ${new Date(user.signed_up_at).toLocaleString()}
Last Active: ${user.last_active_at ? new Date(user.last_active_at).toLocaleString() : 'Never'}
            `;
            alert(details);
        }

        // Engagement report
        function showEngagementReport() {
            const paidUsers = allUsers.filter(u => u.status === 'paid').length;
            const conversionRate = allUsers.length > 0 ? Math.round((paidUsers / allUsers.length) * 100) : 0;
            const mrr = paidUsers * 250;

            const high = allUsers.filter(u => calculateEngagementScore(u) >= 75).length;
            const medium = allUsers.filter(u => calculateEngagementScore(u) >= 50 && calculateEngagementScore(u) < 75).length;
            const low = allUsers.filter(u => calculateEngagementScore(u) >= 25 && calculateEngagementScore(u) < 50).length;
            const none = allUsers.filter(u => calculateEngagementScore(u) < 25).length;

            const avgEngagement = allUsers.length > 0
                ? Math.round(allUsers.reduce((sum, u) => sum + calculateEngagementScore(u), 0) / allUsers.length)
                : 0;

            const report = `
üí∞ B2C FREEMIUM METRICS

Total Users: ${allUsers.length}
Paid Subscribers: ${paidUsers}
Conversion Rate: ${conversionRate}%
Monthly Revenue: KES ${mrr.toLocaleString()}

ENGAGEMENT BREAKDOWN:
üî• High (75%+): ${high} users (${Math.round(high/allUsers.length*100)}%)
‚ö° Medium (50-74%): ${medium} users (${Math.round(medium/allUsers.length*100)}%)
üí§ Low (25-49%): ${low} users (${Math.round(low/allUsers.length*100)}%)
‚ùå None (<25%): ${none} users (${Math.round(none/allUsers.length*100)}%)

Average Engagement: ${avgEngagement}%

üéØ GOAL: 20% conversion rate
STATUS: ${conversionRate >= 20 ? '‚úÖ ACHIEVED!' : `‚è≥ Need ${Math.ceil((20 - conversionRate) * allUsers.length / 100)} more conversions`}

NEXT MILESTONE: ${allUsers.length < 50 ? `Get ${50 - allUsers.length} more signups` : 'Scale to 200 users'}
            `;
            alert(report);
        }

        // Load dashboard on page load
        loadDashboard();

        // Auto-refresh every 30 seconds
        setInterval(loadDashboard, 30000);
    </script>
</body>
</html>
